name: Deploy Workflow

# Trigger automatic on merge to main, also allow manual run
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Optional Docker image tag to deploy (defaults to latest)'
        required: false
        default: ''

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: Build and test
        run: ./gradlew clean build

      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine Docker tag
        id: tag
        run: |
          # If pushed to main → build 'latest'
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            TAG=latest
            BUILD_IMAGE=true
          # Manual trigger with tag → use it
          elif [ -n "${{ github.event.inputs.image_tag }}" ]; then
            TAG=${{ github.event.inputs.image_tag }}
            BUILD_IMAGE=false
          # Manual trigger without tag → use existing latest
          else
            TAG=latest
            BUILD_IMAGE=false
          fi
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "BUILD_IMAGE=$BUILD_IMAGE" >> $GITHUB_OUTPUT
          echo "Using Docker tag: $TAG, build image: $BUILD_IMAGE"

      - name: Build and push Docker image
        if: steps.tag.outputs.BUILD_IMAGE == 'true'
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/lobi-backend
          docker build -t $IMAGE:${{ steps.tag.outputs.TAG }} .
          docker push $IMAGE:${{ steps.tag.outputs.TAG }}
          echo "Docker image pushed: $IMAGE:${{ steps.tag.outputs.TAG }}"

      - name: Deploy to Staging (automatic/manual)
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/lobi/staging/lobi-backend
            export DEPLOY_TAG=${{ steps.tag.outputs.TAG }}
            git pull
            docker compose --env-file .env.staging pull
            docker compose --env-file .env.staging up -d

  deploy-production:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    environment:
      name: production   # must configure protection rules for manual approval
    steps:
      - name: Deploy to Production (manual approval required)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/lobi/production/lobi-backend
            export DEPLOY_TAG=${{ needs.build-and-deploy.outputs.TAG }}
            docker compose --env-file .env.production pull
            docker compose --env-file .env.production up -d
